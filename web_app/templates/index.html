<!DOCTYPE html>
<html>
<head>
    <title>Smart Gardening Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        // Screen controls
        function showScreen(id) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => s.style.display = 'none');
            const el = document.getElementById(id);
            if (el) el.style.display = 'block';
        }

        function startLandingSequence() {
            const msg1 = document.getElementById('landing-msg-1');
            const msg2 = document.getElementById('landing-msg-2');
            const cta = document.getElementById('get-started-btn');
            if (!msg1 || !msg2 || !cta) return;

            // Step 1: Fade in first message
            msg1.classList.add('fade-in');
            setTimeout(() => {
                // Step 2: Fade out first, then show second
                msg1.classList.remove('fade-in');
                msg1.classList.add('fade-out');
                setTimeout(() => {
                    msg1.style.display = 'none';
                    msg2.style.display = 'block';
                    msg2.classList.add('fade-in');
                    // Step 3: Show CTA
                    setTimeout(() => {
                        cta.style.display = 'inline-block';
                        cta.classList.add('fade-in');
                    }, 800);
                }, 800);
            }, 1200);
        }

        // Existing helpers
        function toggleMode() {
            const selectEl = document.getElementById('mode');
            const plantField = document.getElementById('plant-field');
            if (!selectEl || !plantField) return;
            const mode = selectEl.value;
            plantField.style.display = (mode === 'diagnose') ? 'block' : 'none';
        }

        function selectModeAndContinue(mode) {
            const selectEl = document.getElementById('mode');
            selectEl.value = mode;
            toggleMode();
            showScreen('screen-3');
        }

        function toggleTooltip(id) {
            const tooltip = document.getElementById(id);
            if (!tooltip) return;
            tooltip.style.display = tooltip.style.display === 'block' ? 'none' : 'block';
        }

        function setDefault(field, value) {
            const el = document.getElementsByName(field)[0];
            if (el) el.value = value;
        }

        function setAllDefaults() {
            setDefault('n', 50);
            setDefault('p', 50);
            setDefault('k', 50);
            setDefault('ph', 6.5);
            setDefault('temperature', 25);
            setDefault('humidity', 70);
            setDefault('rainfall', 150);
        }

        function updateSoilImage() {
            const soilTypeEl = document.getElementById('soil_type');
            const soilPreview = document.getElementById('soil-preview');
            if (!soilTypeEl || !soilPreview) return;
            const soilType = soilTypeEl.value;
            const soilImages = {
                'Clay': 'https://images.unsplash.com/photo-1628600185380-58f5b1e663ae?w=300&h=200&fit=crop',
                'Loam': 'https://images.unsplash.com/photo-1530836369250-ef72a3f5cda8?w=300&h=200&fit=crop',
                'Sandy': 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=300&h=200&fit=crop'
            };
            const src = soilImages[soilType];
            if (src) {
                soilPreview.src = src;
                soilPreview.style.display = 'block';
            } else {
                soilPreview.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const hasResultAttr = (document.body.dataset?.hasResult || document.body.getAttribute('data-has-result') || 'False').toString().toLowerCase();
            const hasErrorAttr = (document.body.dataset?.hasError || document.body.getAttribute('data-has-error') || 'False').toString().toLowerCase();
            const hasResult = hasResultAttr === 'true';
            const hasError = hasErrorAttr === 'true';

            if (hasResult || hasError) {
                showScreen('screen-3');
            } else {
                showScreen('screen-1');
                startLandingSequence();
            }

            toggleMode();
            updateSoilImage();
        });
    </script>
</head>
<body data-has-result="{{ (result is not none) }}" data-has-error="{{ (error is not none) }}">

<div class="app">
    <!-- SCREEN 1: Landing -->
    <section id="screen-1" class="screen landing">
        <div class="landing-inner">
            <h1 class="brand">Verdantia</h1>
            <p id="landing-msg-1" class="landing-message">Hi, welcome to Verdantia</p>
            <p id="landing-msg-2" class="landing-message" style="display:none;">Your Smart Gardening Assistant</p>
            <button id="get-started-btn" class="cta" style="display:none;" onclick="showScreen('screen-2')">Get Started</button>
        </div>
    </section>

    <!-- SCREEN 2: Mode Selection -->
    <section id="screen-2" class="screen mode-select" style="display:none;">
        <div class="mode-inner">
            <h2>What would you like to do?</h2>
            <div class="mode-options">
                <button class="mode-card" onclick="selectModeAndContinue('recommend')">
                    <span class="mode-emoji">üå±</span>
                    <span class="mode-title">Plant Recommendation</span>
                </button>
                <button class="mode-card" onclick="selectModeAndContinue('diagnose')">
                    <span class="mode-emoji">üåø</span>
                    <span class="mode-title">Plant Health Advisor</span>
                </button>
            </div>
        </div>
    </section>

    <!-- SCREEN 3: Form + Results -->
    <section id="screen-3" class="screen form-screen" style="display:none;">
        <h1> Verdantia - Smart Gardening Assistant</h1>

        <form method="POST">
    <div class="mode-selector">
        <label><strong>What would you like to do?</strong></label>
        <select name="mode" id="mode" onchange="toggleMode()">
            <option value="recommend">Get Plant Recommendation</option>
            <option value="diagnose">Diagnose My Plant Health</option>
        </select>
    </div>

    <div id="plant-field" style="display: none;">
        <label>Current Plant (for diagnosis)</label>
        <input type="text" name="current_plant" placeholder="e.g., tomato, lettuce, rice">
    </div>

    <h3>Environmental Conditions</h3>

    <div class="input-group">
        <label>Nitrogen (N) 
            <button type="button" class="info-btn" onclick="toggleTooltip('tooltip-n')">
                <img src="{{ url_for('static', filename='info-icon.svg') }}" alt="info" class="info-icon">
            </button>
        </label>
        <div id="tooltip-n" class="tooltip">
            <strong>Nitrogen (N):</strong> Essential for leaf growth and green color. Typical range: 0-140 kg/ha.<br>
            <strong>üí∞ No test kit?</strong> Visual clues:<br>
            ‚Ä¢ Dark green leaves = High (60-90)<br>
            ‚Ä¢ Yellow/pale leaves = Low (20-40)<br>
            ‚Ä¢ Normal green = Medium (40-60)<br>
            <button type="button" class="default-btn" onclick="setDefault('n', 50)">Use Typical (50)</button>
        </div>
        <input type="number" step="any" name="n" required placeholder="e.g., 90">
    </div>

    <div class="input-group">
        <label>Phosphorus (P) 
            <button type="button" class="info-btn" onclick="toggleTooltip('tooltip-p')">
                <img src="{{ url_for('static', filename='info-icon.svg') }}" alt="info" class="info-icon">
            </button>
        </label>
        <div id="tooltip-p" class="tooltip">
            <strong>Phosphorus (P):</strong> Vital for root development, flowering, and fruiting. Typical range: 5-145 kg/ha.<br>
            <strong>üí∞ No test kit?</strong> Observe plants:<br>
            ‚Ä¢ Purple/dark leaves = Low (20-40)<br>
            ‚Ä¢ Slow flowering = Low (20-40)<br>
            ‚Ä¢ Normal growth = Medium (40-60)<br>
            <button type="button" class="default-btn" onclick="setDefault('p', 50)">Use Typical (50)</button>
        </div>
        <input type="number" step="any" name="p" required placeholder="e.g., 42">
    </div>

    <div class="input-group">
        <label>Potassium (K) 
            <button type="button" class="info-btn" onclick="toggleTooltip('tooltip-k')">
                <img src="{{ url_for('static', filename='info-icon.svg') }}" alt="info" class="info-icon">
            </button>
        </label>
        <div id="tooltip-k" class="tooltip">
            <strong>Potassium (K):</strong> Strengthens plants, improves disease resistance. Typical range: 5-205 kg/ha.<br>
            <strong>üí∞ No test kit?</strong> Signs:<br>
            ‚Ä¢ Brown leaf edges = Low (20-40)<br>
            ‚Ä¢ Weak stems = Low (20-40)<br>
            ‚Ä¢ Healthy stems = Medium (40-60)<br>
            <button type="button" class="default-btn" onclick="setDefault('k', 50)">Use Typical (50)</button>
        </div>
        <input type="number" step="any" name="k" required placeholder="e.g., 43">
    </div>

    <div class="input-group">
        <label>pH Level 
            <button type="button" class="info-btn" onclick="toggleTooltip('tooltip-ph')">
                <img src="{{ url_for('static', filename='info-icon.svg') }}" alt="info" class="info-icon">
            </button>
        </label>
        <div id="tooltip-ph" class="tooltip">
            <strong>pH Level:</strong> Measures soil acidity/alkalinity. Scale: 0-14. Neutral = 7. Most plants prefer 6-7.5.<br>
            <strong>üí∞ DIY Test:</strong><br>
            ‚Ä¢ Mix soil + vinegar ‚Üí Fizzes = Alkaline (7.5+)<br>
            ‚Ä¢ Mix soil + baking soda water ‚Üí Fizzes = Acidic (5.5-)<br>
            ‚Ä¢ No fizz = Neutral (6-7)<br>
            <strong>Or use red cabbage juice as pH indicator!</strong><br>
            <button type="button" class="default-btn" onclick="setDefault('ph', 6.5)">Use Neutral (6.5)</button>
        </div>
        <input type="number" step="any" name="ph" required placeholder="e.g., 6.5" min="0" max="14">
    </div>

    <div class="input-group">
        <label>Temperature (¬∞C) 
            <button type="button" class="info-btn" onclick="toggleTooltip('tooltip-temp')">
                <img src="{{ url_for('static', filename='info-icon.svg') }}" alt="info" class="info-icon">
            </button>
        </label>
        <div id="tooltip-temp" class="tooltip">
            <strong>Temperature:</strong> Average daily temperature in Celsius. Typical range: 8-45¬∞C.<br>
            <strong>üí∞ Free:</strong> Check weather apps, Google, or weather.com for your location.<br>
            <button type="button" class="default-btn" onclick="setDefault('temperature', 25)">Use Tropical (25¬∞C)</button>
        </div>
        <input type="number" step="any" name="temperature" required placeholder="e.g., 25">
    </div>

    <div class="input-group">
        <label>Humidity (%) 
            <button type="button" class="info-btn" onclick="toggleTooltip('tooltip-humidity')">
                <img src="{{ url_for('static', filename='info-icon.svg') }}" alt="info" class="info-icon">
            </button>
        </label>
        <div id="tooltip-humidity" class="tooltip">
            <strong>Humidity:</strong> Percentage of moisture in the air. Range: 14-100%.<br>
            <strong>üí∞ Free:</strong> Check weather apps or websites.<br>
            ‚Ä¢ Coastal/rainy areas: 70-90%<br>
            ‚Ä¢ Dry areas: 30-50%<br>
            <button type="button" class="default-btn" onclick="setDefault('humidity', 70)">Use Typical (70%)</button>
        </div>
        <input type="number" step="any" name="humidity" required placeholder="e.g., 80" min="0" max="100">
    </div>

    <div class="input-group">
        <label>Rainfall (mm) 
            <button type="button" class="info-btn" onclick="toggleTooltip('tooltip-rainfall')">
                <img src="{{ url_for('static', filename='info-icon.svg') }}" alt="info" class="info-icon">
            </button>
        </label>
        <div id="tooltip-rainfall" class="tooltip">
            <strong>Rainfall:</strong> Average monthly or annual rainfall in millimeters.<br>
            <strong>üí∞ Free:</strong> Google "average rainfall [your city]" or check weather websites.<br>
            ‚Ä¢ Heavy rain: 200+ mm/month<br>
            ‚Ä¢ Moderate: 100-200 mm/month<br>
            ‚Ä¢ Light: 50-100 mm/month<br>
            <button type="button" class="default-btn" onclick="setDefault('rainfall', 150)">Use Moderate (150mm)</button>
        </div>
        <input type="number" step="any" name="rainfall" required placeholder="e.g., 200">
    </div>

    <div class="input-group">
        <label>Soil Type 
            <button type="button" class="info-btn" onclick="toggleTooltip('tooltip-soil')">
                <img src="{{ url_for('static', filename='info-icon.svg') }}" alt="info" class="info-icon">
            </button>
        </label>
        <div id="tooltip-soil" class="tooltip">
            <strong>Soil Types:</strong><br>
            ‚Ä¢ <strong>Clay:</strong> Heavy, sticky when wet, holds water well<br>
            ‚Ä¢ <strong>Loam:</strong> Balanced mix, ideal for most plants<br>
            ‚Ä¢ <strong>Sandy:</strong> Light, drains quickly, feels gritty
        </div>
        <select name="soil_type" id="soil_type" onchange="updateSoilImage()">
            <option value="Clay">Clay (Heavy, water-retaining)</option>
            <option value="Loam">Loam (Balanced, ideal)</option>
            <option value="Sandy">Sandy (Light, fast-draining)</option>
        </select>
        <img id="soil-preview" class="soil-preview" alt="Soil preview">
    </div>

    <div class="input-group">
        <label>Climate Type 
            <button type="button" class="info-btn" onclick="toggleTooltip('tooltip-climate')">
                <img src="{{ url_for('static', filename='info-icon.svg') }}" alt="info" class="info-icon">
            </button>
        </label>
        <div id="tooltip-climate" class="tooltip">
            <strong>Climate Types:</strong><br>
            ‚Ä¢ <strong>Tropical Wet:</strong> High rainfall year-round<br>
            ‚Ä¢ <strong>Tropical Moist:</strong> Wet/dry seasons<br>
            ‚Ä¢ <strong>Tropical Dry:</strong> Long dry periods<br>
            ‚Ä¢ <strong>Urban Heat Zone:</strong> City areas with heat buildup
        </div>
        <select name="climate">
            <option value="Tropical Wet">Tropical Wet (Rainy year-round)</option>
            <option value="Tropical Moist">Tropical Moist (Seasonal rain)</option>
            <option value="Tropical Dry">Tropical Dry (Long dry spells)</option>
            <option value="Urban Heat Zone">Urban Heat Zone (City heat)</option>
        </select>
    </div>

    <div class="default-all-section">
        <p><strong>üí° Don't have testing equipment?</strong></p>
        <button type="button" class="default-all-btn" onclick="setAllDefaults()">üìù Fill with Typical Values</button>
        <p class="hint-text">Use typical values for tropical gardening, then adjust based on your observations</p>
    </div>

    <button type="submit">Analyze</button>
        </form>

{% if error %}
<div class="error">
    <h2>‚ö†Ô∏è Error</h2>
    <p>{{ error }}</p>
</div>
{% endif %}

{% if result %}
<div class="result">
    <h2>üìä Results</h2>
    
    {% if result.mode == 'recommend' %}
        <div class="recommendation">
            <h3>üåæ Recommended Crop</h3>
            <div class="crop-display">
                <div class="crop-icon">
                    {% if result.crop in ['rice', 'wheat', 'maize'] %}
                        üåæ
                    {% elif result.crop in ['apple', 'banana', 'mango', 'orange', 'papaya', 'watermelon', 'grapes', 'pomegranate'] %}
                        üçé
                    {% elif result.crop in ['tomato', 'potato', 'carrot', 'lettuce', 'spinach'] %}
                        ü•¨
                    {% elif result.crop in ['coffee', 'cotton'] %}
                        ‚òï
                    {% else %}
                        üå±
                    {% endif %}
                </div>
                <p class="crop-name">{{ result.crop }}</p>
            </div>
            <p><strong>Message:</strong> {{ result.message }}</p>
        </div>
    {% elif result.mode == 'diagnose' %}
        <div class="diagnosis">
            <h3>üîç Plant Health Diagnosis: {{ result.plant }}</h3>
            <div class="condition-badge condition-{{ result.condition.lower().replace(' ', '-') }}">
                {% if result.condition == 'Healthy' %}
                    ‚úÖ {{ result.condition }}
                {% elif result.condition in ['Overwatered', 'Flood / Waterlogging Risk'] %}
                    üíß {{ result.condition }}
                {% elif result.condition == 'Underwatered' %}
                    üèúÔ∏è {{ result.condition }}
                {% elif result.condition == 'Pest Risk' %}
                    üêõ {{ result.condition }}
                {% elif result.condition == 'Nutrient Deficiency' %}
                    üå± {{ result.condition }}
                {% else %}
                    ‚ö†Ô∏è {{ result.condition }}
                {% endif %}
            </div>
            <p><strong>Reason:</strong> {{ result.reason }}</p>
            <p><strong>üí° Advice:</strong> {{ result.advice }}</p>
        </div>
    {% endif %}
    
    <details class="details">
        <summary>View Environmental Conditions</summary>
        <ul>
            <li>Nitrogen: {{ result.inputs.n }}</li>
            <li>Phosphorus: {{ result.inputs.p }}</li>
            <li>Potassium: {{ result.inputs.k }}</li>
            <li>Temperature: {{ result.inputs.temperature }}¬∞C</li>
            <li>Humidity: {{ result.inputs.humidity }}%</li>
            <li>Rainfall: {{ result.inputs.rainfall }}mm</li>
            <li>Soil Type: {{ result.inputs.soil_type }}</li>
            <li>Climate: {{ result.inputs.climate }}</li>
        </ul>
    </details>
</div>
{% endif %}

    </section>
</div>

</body>
</html>
